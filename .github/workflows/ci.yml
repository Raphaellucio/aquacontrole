name: CI - AquaControle

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  backend:
    name: Backend (Django)
    runs-on: ubuntu-latest

    steps:
      - name: Baixar o código do repositório
        uses: actions/checkout@v4

      - name: Mostrar estrutura (debug rápido)
        run: |
          echo "Raiz do repo:"
          ls -la
          echo ""
          echo "Conteúdo de backend (se existir):"
          if [ -d backend ]; then ls -la backend; else echo "❌ Pasta backend NÃO existe no GitHub."; fi

      - name: Preparar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Rodar Django (somente se existir backend/manage.py)
        run: |
          if [ ! -f backend/manage.py ]; then
            echo "❌ Não achei backend/manage.py no GitHub."
            echo "✅ Correção: no GitHub, a pasta backend precisa existir e conter manage.py."
            exit 1
          fi

          cd backend
          python -m pip install --upgrade pip

          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "⚠️ requirements.txt não encontrado. Instalando pacotes mínimos..."
            pip install django djangorestframework django-cors-headers
          fi

          python manage.py check
          python manage.py migrate --noinput
          python manage.py test

  frontend:
    name: Frontend (React)
    runs-on: ubuntu-latest

    steps:
      - name: Baixar o código do repositório
        uses: actions/checkout@v4

      - name: Mostrar estrutura (debug rápido)
        run: |
          echo "Conteúdo de frontend (se existir):"
          if [ -d frontend ]; then ls -la frontend; else echo "❌ Pasta frontend NÃO existe no GitHub."; fi

      - name: Preparar Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build React (somente se existir frontend/package.json)
        run: |
          if [ ! -f frontend/package.json ]; then
            echo "❌ Não achei frontend/package.json no GitHub."
            echo "✅ Correção: no GitHub, a pasta frontend precisa existir e conter package.json."
            exit 1
          fi

          cd frontend
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

          npm run build
